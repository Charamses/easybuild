.. _singularity_support:

EasyBuild Singularity (Experimental)
====================================

Introduction
------------

* ``--containerize``/``-C`` to enable generating of container recipes in path specified by ``--containerpath``
* various ``--container-*`` options to control the behavior
* ``--container-build-image`` to enable building of container image with generating recipe by calling out to ``sudo singularity``
* ``--container-image-format`` to specify desired image of container images to be built (``ext3``, ``sandbox`` or ``squashfs`` (default))
* ``--container-image-name`` to control name of generated container recipe & image

Currently relies on a base container image being used (to be specified via `--container-base`), see https://singularity-hub.org/collections/143.

Requires use of ``--experimental`` since the functionality is subject to change.



Singularity Options
-------------------

``eb`` comes with a several options to control singularity configuration for creating
singularity recipe and containers.

Shown below is a list of container options.

.. code::


   -C, --containerize  Generate container recipe/image (def False)

    --containerpath=CONTAINERPATH
                        Location where container recipe & image will be stored (def /home/siddis14/.local/easybuild/containers)

  Container options:
    Options related to generating container recipes & images (configfile section container)

    --container-base=BASE
                        Base for container image. Examples (for Singularity): --container-base localimage:/path/to/image.img, --container-base shub:<image>:<tag>, --container-base docker:<image>:<tag>
                        (type <type 'str'>)
    --container-build-image
                        Build container image (requires sudo privileges!) (def False)
    --container-image-format=IMAGE-FORMAT
                        Container image format (type choice) (choices: ext3, sandbox, squashfs)
    --container-image-name=IMAGE-NAME
                        Custom name for container image (defaults to name of easyconfig)
    --container-type=TYPE
                        Type of container recipe/image to create (type choice; def singularity) (choices: docker, singularity)

Modifying Container Path
------------------------

You may want to modify path where to write container and recipe file. This can be done at the command line ``--containerpath``, environment variable ``EASYBUILD_CONTAINERPATH`` or configuration file
``$HOME/.config/easybuild/config.cfg``


The default path will be ``$HOME/.local/easybuild/containers`` but this can be changed to any directory in filesystem


Command Line
~~~~~~~~~~~~

.. code::

        eb --containerpathpath=/path/to/easybuild_containers


Environment Variable
~~~~~~~~~~~~~~~~~~~~

.. code::

        export EASYBUILD_CONTAINERPATH=$HOME
        eb --show-full-config | grep containerpath
        containerpath                           (E) = /home/siddis14

Configuration File
~~~~~~~~~~~~~~~~~~

.. code::

        [config]
        containerpath = /path/to/easybuild_containers


.. Note::

    If you are building containers please choose a path in filesystem with sufficient storage so you don't run out of space. Singularity
    will pull metadata during the builds and each image can range from several hundred MBs to few GBs depending on application.

Singularity Recipes
-------------------

easybuild will generate singularity recipe files that are used for building Singularity containers. Users can build containers on-prem or cloud. You may build your containers through ``singularity`` command or use ``eb --container-build`` which will invoke ``sudo singularity build``. You must be root to do this operation or have sudo rights. Also note you must have singularity 2.4 to use this feature since eb will invoke ``singularity build`` prior version of singularity used ``singularity bootstrap`` which is deprecated

If you dont have root, you may upload your recipe to github and use Singularity Hub to build your containers.

The general structure of a generated recipe file will look as follows.

.. code::


   Bootstrap: shub
   From: shahzebsiddiqui/eb-singularity:centos-7.3.1611

   %post


   # upgrade easybuild package automatically to latest version
   pip install -U easybuild

   # change to 'easybuild' user
   su - easybuild

   eb M4-1.4.17.eb --robot --installpath=/app/ --prefix=/scratch --tmpdir=/scratch/tmp

   # exit from 'easybuild' user
   exit

   # cleanup
   rm -rf /scratch/tmp/* /scratch/build /scratch/sources /scratch/ebfiles_repo

   %runscript
   eval "$@"

   %environment
   source /etc/profile
   module use /app/modules/all
   module load M4/1.4.17

   %labels

This is a generated recipe file for ``M4-1.4.17.eb`` that can be generated by running ``eb M4-1.4.17.eb -C --experimental --container-base shub:shahzebsiddiqui/eb-singularity:centos-7.3.1611``

We are using the base easybuild container ``shahzebsiddiqui/eb-singularity:centos-7.3.1611`` which can be found in SHUB at https://singularity-hub.org/containers/1714 

Easybuild Base Containers
-------------------------

To get started there are two easybuild bootstrap containers for centos 7.3.1611 and centos 7.4.1708 in Singularity HUB. You may pull these containers from SHUB to see how they are built.

.. code::

        singularity pull shub://shahzebsiddiqui/eb-singularity:centos-7.3.1611
        singularity pull shub://shahzebsiddiqui/eb-singularity:centos-7.4.1708

You will be using these images with ``--container-base`` with ``shub`` option to initialize the base container (i.e Bootstrap)

In the future, easybuild will provide a few base containers that could be available in SHUB and DockerHUB.

The base container creates a user ``easybuild`` which will be used for invoking ``eb`` inside the container. The base container installs the dependencies required to install easybuild and precreates a few directory path that is owned by ``easybuild`` for ``eb`` that is needed for pulling source files, building, writing logs, and installation path.

eb will insert ``pip install -U easybuild`` inside the recipe file to ensure easybuild is updated when building container because base container may have an older version. This was done to avoid creating another base container for every easybuild release. Also some apps break with older version of easybuild-framework and it does not capture the new easyconfigs from the host system.

easybuild will support ``EasyBuildMNS`` module naming scheme inside the container and this was done to avoid further complexity to ensure startup container environment was set properly (``%environment`` section)  

Getting Started
---------------

In order to use easybuild with singularity you must use the option ``--experimental`` for the time being.

If you want to build the singularity recipe for ``M4-1.4.17.eb`` with the base container ``shahzebsiddiqui/eb-singularity:centos-7.3.1611`` then you can do the following

.. code::

   $ eb M4-1.4.17.eb -C --experimental --container-base shub:shahzebsiddiqui/eb-singularity:centos-7.3.1611
   == temporary log file in case of crash /tmp/eb-nuDM_3/easybuild-Y0PyDr.log
   == Singularity definition file created at /home/siddis14/.local/easybuild/containers/Singularity.M4-1.4.17
   == Temporary log file(s) /tmp/eb-nuDM_3/easybuild-Y0PyDr.log* have been removed.
   == Temporary directory /tmp/eb-nuDM_3 has been removed.

The recipe file will be in the format ``Singularity.<easyconfig>`` by default which is the intended if you plan to build these containers in SHUB. For more information on Singularity Recipes for Singularity Hub see https://github.com/singularityhub/singularityhub.github.io/wiki/Build-A-Container 

If you try rerunning the command you will get the following error

.. code::

  $ eb M4-1.4.17.eb -C --experimental --container-base shub:shahzebsiddiqui/eb-singularity:centos-7.3.1611
   == temporary log file in case of crash /tmp/eb-t75EMP/easybuild-3c0F9i.log
   ERROR: Container recipe at /home/siddis14/.local/easybuild/containers/Singularity.M4-1.4.17 already exists, not overwriting it without --force


This was intended to avoid overwriting singularity recipe files so in this case use the ``--force`` option to overwrite the recipe file.

.. code::

  $ eb M4-1.4.17.eb -C --experimental --container-base shub:shahzebsiddiqui/eb-singularity:centos-7.3.1611 --force
   == temporary log file in case of crash /tmp/eb-6wPdUe/easybuild-b9EzD_.log
   == WARNING: overwriting existing container recipe at /home/siddis14/.local/easybuild/containers/Singularity.M4-1.4.17 due to --force
   == Singularity definition file created at /home/siddis14/.local/easybuild/containers/Singularity.M4-1.4.17
   == Temporary log file(s) /tmp/eb-6wPdUe/easybuild-b9EzD_.log* have been removed.
   == Temporary directory /tmp/eb-6wPdUe has been removed.


If you want to build a container and have sudo rights you may run the ``--container-build`` option. If you don't have sudo rights either copy the recipe to a system where you have sudo rights or build it in Singularity Hub. 

.. code::

   $ eb M4-1.4.17.eb -C --experimental --container-base shub:shahzebsiddiqui/eb-singularity:centos-7.3.1611 --force --container-build
   == temporary log file in case of crash /tmp/eb-WTrmaL/easybuild-zrAnfe.log
   == Singularity tool found at /usr/local/bin/singularity
   == Singularity version '2.4' is 2.4 or higher ... OK
   == WARNING: overwriting existing container recipe at /home/siddis14/.local/easybuild/containers/Singularity.M4-1.4.17 due to --force
   == Singularity definition file created at /home/siddis14/.local/easybuild/containers/Singularity.M4-1.4.17
   == Running 'sudo singularity build  /home/siddis14/.local/easybuild/containers/M4-1.4.17.simg /home/siddis14/.local/easybuild/containers/Singularity.M4-1.4.17', you may need to enter your 'sudo' password...
   [sudo] password for siddis14:
   == Singularity image created at /home/siddis14/.local/easybuild/containers/M4-1.4.17.simg
   == Temporary log file(s) /tmp/eb-WTrmaL/easybuild-zrAnfe.log* have been removed.
   == Temporary directory /tmp/eb-WTrmaL has been removed.

easybuild will build containers using squashfs format (.simg) which is the default image format for singularity containers. Now that you have a container you may shell inside the environment and see the modules. Note you must be in interactive shell (``singularity shell -s /bin/bash``) inside the container if you want ``module`` command to work properly inside the container. This is only an issue with bash and Lmod for more details see https://lmod.readthedocs.io/en/latest/030_installing.html#issues-with-bash 

.. code::

   $ singularity shell -s /bin/bash /home/siddis14/.local/easybuild/containers/M4-1.4.17.simg
   Singularity: Invoking an interactive shell within container...

   Singularity> ml av

   ---------------------------------------------------------------------------------------------- /app/modules/all -----------------------------------------------------------------------------------------------
      M4/1.4.17 (L)

   ------------------------------------------------------------------------------------ /usr/share/lmod/lmod/modulefiles/Core ------------------------------------------------------------------------------------
      lmod/6.5.1    settarg/6.5.1


Note that module will be loaded automatically , if you want to test m4 you may do the following. Note that you don't need to load any module since this is done automatically

.. code::

   $ singularity exec  /home/siddis14/.local/easybuild/containers/M4-1.4.17.simg m4 --version

   m4 (GNU M4) 1.4.17
   Copyright (C) 2013 Free Software Foundation, Inc.
   License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>.
   This is free software: you are free to change and redistribute it.
   There is NO WARRANTY, to the extent permitted by law.
   

easybuild will install apps in ``/app/`` so you can run ``which`` command to determine if your binary is from easybuild or a system binary

.. code::

   $ singularity exec  /home/siddis14/.local/easybuild/containers/M4-1.4.17.simg which m4
   /app/software/M4/1.4.17/bin/m4


Other Bootstrap options
-----------------------


You may change singularity bootstrap agent to docker or localimage. localimage bootstrap can be useful if you plan to build
containers on-prem. Let's suppose you do the following

.. code::

        cd $HOME
        singularity pull shub://shahzebsiddiqui/eb-singularity:centos-7.3.1611

Now you can specify localimage as bootstrap as follows

.. code::

   [siddis14@amrndhl1157 easybuild-framework]$ eb Anaconda3-4.2.0.eb -C --container-base localimage:$HOME/shahzebsiddiqui-eb-singularity-eb_images.simg --experimental
   == temporary log file in case of crash /tmp/eb-Wml38a/easybuild-0084Nv.log
   == Singularity definition file created at /home/siddis14/.local/easybuild/containers/Singularity.Anaconda3-4.2.0
   == Temporary log file(s) /tmp/eb-Wml38a/easybuild-0084Nv.log* have been removed.
   == Temporary directory /tmp/eb-Wml38a has been removed.

If we peek into the recipe file we notice the ``Bootstrap:`` section is will use ``localimage`` and ``From:`` will use the container we pulled.

.. code::

   [siddis14@amrndhl1157 easybuild-framework]$ head  /home/siddis14/.local/easybuild/containers/Singularity.Anaconda3-4.2.0

   Bootstrap: localimage
   From: /home/siddis14/shahzebsiddiqui-eb-singularity-eb_images.simg

easybuild will do some checks to ensure you specify a valid container for bootstrapping the container. For instance if user specifies an invalid path you will get the following

.. code::

   [siddis14@amrndhl1157 easybuild-framework]$ eb Anaconda3-4.2.0.eb -C --container-base localimage:$HOME/shahzebsiddiqui-eb-singularity-eb_images.simg1 --experimental
   == temporary log file in case of crash /tmp/eb-uBjx2_/easybuild-MrhODZ.log
   ERROR: Singularity base image at specified path does not exist: /home/siddis14/shahzebsiddiqui-eb-singularity-eb_images.simg1

Easybuild will only bootstrap from squashfs(.simg) and ext3(.img) image formats. easybuild will look for file extension so in the case of localimage bootstrap you may get the following error 

.. code::

   [siddis14@amrndhl1157 easybuild-framework]$  eb Anaconda3-4.2.0.eb -C --container-base localimage:$HOME/.local/easybuild/containers/git-lfs-1.1.1/ --experimental
   == temporary log file in case of crash /tmp/eb-EoN_Dw/easybuild-7_P_YM.log
   ERROR: Invalid image extension '' must be .img or .simg

Currently there is no easybuild base container in docker which be coming soon. You may still try to bootstrap with docker container but it will not work for building images. easybuild can generate the recipe files with docker bootstrap.        

.. code::

   $ eb M4-1.4.17.eb -C --experimental --container-base docker:centos:7.3.1611 --force
   == temporary log file in case of crash /tmp/eb-Ya8D6t/easybuild-HIlT6S.log
   == WARNING: overwriting existing container recipe at /home/siddis14/.local/easybuild/containers/Singularity.M4-1.4.17 due to --force
   == Singularity definition file created at /home/siddis14/.local/easybuild/containers/Singularity.M4-1.4.17
   == Temporary log file(s) /tmp/eb-Ya8D6t/easybuild-HIlT6S.log* have been removed.
   == Temporary directory /tmp/eb-Ya8D6t has been removed.

   $ head /home/siddis14/.local/easybuild/containers/Singularity.M4-1.4.17

   Bootstrap: docker
   From: centos:7.3.1611

Image Formats
-------------

Singularity support three image formats ``squashfs`` ``sandbox`` ``ext3``. The default image format is squashfs with extension ``.simg``. ext3 has image format ``.img`` which can be used to edit container as root but not allowed in squashfs. Sandbox
will create a directory structure for container image that can be useful for testing an application container. For more details on image format see http://singularity.lbl.gov/docs-build-container

easybuild will use squashfs image format by default but if you want to change the image format use ``--container-image-format`` option 

Example with squashfs format

.. code::

      [siddis14@amrndhl1157 easybuild-framework]$ eb M4-1.4.18.eb -C --container-base shub:shahzebsiddiqui/eb-singularity:centos-7.3.1611 --container-build  --experimental --force --containerpath /lustre/workspace/home/siddis14/ebimages/
   == temporary log file in case of crash /tmp/eb-UKlC3G/easybuild-gJJX01.log
   == Singularity tool found at /usr/local/bin/singularity
   == Singularity version '2.4' is 2.4 or higher ... OK
   == WARNING: overwriting existing container recipe at /lustre/workspace/home/siddis14/ebimages/Singularity.M4-1.4.18 due to --force
   == Singularity definition file created at /lustre/workspace/home/siddis14/ebimages/Singularity.M4-1.4.18
   == WARNING: overwriting existing container image at /lustre/workspace/home/siddis14/ebimages/M4-1.4.18.simg due to --force
   == Running 'sudo singularity build  /lustre/workspace/home/siddis14/ebimages/M4-1.4.18.simg /lustre/workspace/home/siddis14/ebimages/Singularity.M4-1.4.18', you may need to enter your 'sudo' password...
   == (streaming) output for command 'sudo singularity build  /lustre/workspace/home/siddis14/ebimages/M4-1.4.18.simg /lustre/workspace/home/siddis14/ebimages/Singularity.M4-1.4.18':
   [sudo] password for siddis14:
   Using container recipe deffile: /lustre/workspace/home/siddis14/ebimages/Singularity.M4-1.4.18
   Sanitizing environment
   Adding base Singularity environment to container
   Progress |===================================| 100.0%

   ...
   
   Building Singularity image...
   Singularity container built: /lustre/workspace/home/siddis14/ebimages/M4-1.4.18.simg
   Cleaning up...
   == Singularity image created at /lustre/workspace/home/siddis14/ebimages/M4-1.4.18.simg
   == Temporary log file(s) /tmp/eb-UKlC3G/easybuild-gJJX01.log* have been removed.
   == Temporary directory /tmp/eb-UKlC3G has been removed.

   
Example using ext3 image format

.. code::

    [siddis14@amrndhl1157 easybuild-framework]$ eb M4-1.4.18.eb -C --container-base shub:shahzebsiddiqui/eb-singularity:centos-7.3.1611 --container-build --container-image-format=ext3 --experimental --force --containerpath /lustre/workspace/home/siddis14/ebimages/
   == temporary log file in case of crash /tmp/eb-suQDHd/easybuild-GPvSr6.log
   == Singularity tool found at /usr/local/bin/singularity
   == Singularity version '2.4' is 2.4 or higher ... OK
   == WARNING: overwriting existing container recipe at /lustre/workspace/home/siddis14/ebimages/Singularity.M4-1.4.18 due to --force
   == Singularity definition file created at /lustre/workspace/home/siddis14/ebimages/Singularity.M4-1.4.18
   == WARNING: overwriting existing container image at /lustre/workspace/home/siddis14/ebimages/M4-1.4.18.img due to --force
   == Running 'sudo singularity build --writable /lustre/workspace/home/siddis14/ebimages/M4-1.4.18.img /lustre/workspace/home/siddis14/ebimages/Singularity.M4-1.4.18', you may need to enter your 'sudo' password...
   == (streaming) output for command 'sudo singularity build --writable /lustre/workspace/home/siddis14/ebimages/M4-1.4.18.img /lustre/workspace/home/siddis14/ebimages/Singularity.M4-1.4.18':
   Using container recipe deffile: /lustre/workspace/home/siddis14/ebimages/Singularity.M4-1.4.18
   Sanitizing environment
   Adding base Singularity environment to container
   Progress |===================================| 100.0%

   ...

   Creating empty Singularity writable container 702MB
   Creating empty 877MiB image file: /lustre/workspace/home/siddis14/ebimages/M4-1.4.18.img
   Formatting image with ext3 file system
   Image is done: /lustre/workspace/home/siddis14/ebimages/M4-1.4.18.img
   Building Singularity image...
   Singularity container built: /lustre/workspace/home/siddis14/ebimages/M4-1.4.18.img
   Cleaning up...
   == Singularity image created at /lustre/workspace/home/siddis14/ebimages/M4-1.4.18.img
   == Temporary log file(s) /tmp/eb-suQDHd/easybuild-GPvSr6.log* have been removed.
   == Temporary directory /tmp/eb-suQDHd has been removed.


Example using sandbox image format

.. code::

   [siddis14@amrndhl1157 easybuild-framework]$ eb M4-1.4.18.eb -C --container-base shub:shahzebsiddiqui/eb-singularity:centos-7.3.1611 --container-build --container-image-format=sandbox --experimental --force --containerpath /lustre/workspace/home/siddis14/ebimages/
   == temporary log file in case of crash /tmp/eb-cajQO_/easybuild-Kz25zI.log
   == Singularity tool found at /usr/local/bin/singularity
   == Singularity version '2.4' is 2.4 or higher ... OK
   == WARNING: overwriting existing container recipe at /lustre/workspace/home/siddis14/ebimages/Singularity.M4-1.4.18 due to --force
   == Singularity definition file created at /lustre/workspace/home/siddis14/ebimages/Singularity.M4-1.4.18
   == Running 'sudo singularity build --sandbox /lustre/workspace/home/siddis14/ebimages/M4-1.4.18 /lustre/workspace/home/siddis14/ebimages/Singularity.M4-1.4.18', you may need to enter your 'sudo' password...
   == (streaming) output for command 'sudo singularity build --sandbox /lustre/workspace/home/siddis14/ebimages/M4-1.4.18 /lustre/workspace/home/siddis14/ebimages/Singularity.M4-1.4.18':
   Using container recipe deffile: /lustre/workspace/home/siddis14/ebimages/Singularity.M4-1.4.18
   Sanitizing environment
   Adding base Singularity environment to container
   Progress |===================================| 100.0%

   ...

   Singularity container built: /lustre/workspace/home/siddis14/ebimages/M4-1.4.18
   Cleaning up...
   == Singularity image created at /lustre/workspace/home/siddis14/ebimages/M4-1.4.18
   == Temporary log file(s) /tmp/eb-cajQO_/easybuild-Kz25zI.log* have been removed.
   == Temporary directory /tmp/eb-cajQO_ has been removed.


See how the three image formats

.. code::

    [siddis14@amrndhl1157 easybuild-framework]$ ls -l /lustre/workspace/home/siddis14/ebimages/M4-1.4.18.*
   -rwxr-xr-x 1 root root 919601183 Apr 19 14:43 /lustre/workspace/home/siddis14/ebimages/M4-1.4.18.img
   -rwxr-xr-x 1 root root 231800863 Apr 19 14:39 /lustre/workspace/home/siddis14/ebimages/M4-1.4.18.simg


   [siddis14@amrndhl1157 easybuild-framework]$ ls -l /lustre/workspace/home/siddis14/ebimages/M4-1.4.18
   total 92
   -rw-r--r--  1 root root     15712 Dec 14  2016 anaconda-post.log
   drwxrwxr-x  4 1000 gcgadmin  4096 Feb 14 12:27 app
   lrwxrwxrwx  1 root root         7 Dec 14  2016 bin -> usr/bin
   drwxr-xr-x  2 root root      4096 Dec 14  2016 dev
   lrwxrwxrwx  1 root root        36 Nov 26 01:54 environment -> .singularity.d/env/90-environment.sh
   drwxr-xr-x 52 root root     12288 Feb 14 12:27 etc
   drwxr-xr-x  3 root root      4096 Feb 14 12:27 home
   lrwxrwxrwx  1 root root         7 Dec 14  2016 lib -> usr/lib
   lrwxrwxrwx  1 root root         9 Dec 14  2016 lib64 -> usr/lib64
   drwx------  2 root root      4096 Dec 14  2016 lost+found
   drwxr-xr-x  2 root root      4096 Nov  5  2016 media
   drwxr-xr-x  2 root root      4096 Nov  5  2016 mnt
   drwxr-xr-x  2 root root      4096 Nov  5  2016 opt
   drwxr-xr-x  2 root root      4096 Dec 14  2016 proc
   dr-xr-x---  4 root root      4096 Feb 14 12:27 root
   drwxr-xr-x 12 root root      4096 Feb 14 12:27 run
   lrwxrwxrwx  1 root root         8 Dec 14  2016 sbin -> usr/sbin
   drwxrwxr-x  3 1000 gcgadmin  4096 Apr 17 19:03 scratch
   lrwxrwxrwx  1 root root        24 Nov 26 01:54 singularity -> .singularity.d/runscript
   drwxr-xr-x  2 root root      4096 Nov  5  2016 srv
   drwxr-xr-x  2 root root      4096 Dec 14  2016 sys
   drwxrwxrwt  7 root root      4096 Dec 14  2016 tmp
   drwxr-xr-x 14 root root      4096 Apr 17 19:01 usr
   drwxr-xr-x 18 root root      4096 Dec 14  2016 var



Custom Image Name
-----------------

If you want to modify the name of the generated recipe file and image you can use ``--container-image-name``. Please note that ``.img`` or ``.simg`` is added to file name if you are building as squashfs or ext3

.. code::

     [siddis14@amrndhl1157 easybuild-framework]$ eb M4-1.4.17.eb -C --container-base shub:shahzebsiddiqui/eb-singularity:centos-7.3.1611 --container-build --container-image-name=M4 --containerpath /lustre/workspace/home/siddis14/ebimages --experimental --force
   == temporary log file in case of crash /tmp/eb-MdArgJ/easybuild-QrrfMy.log
   == Singularity tool found at /usr/local/bin/singularity
   == Singularity version '2.4' is 2.4 or higher ... OK
   == WARNING: overwriting existing container recipe at /lustre/workspace/home/siddis14/ebimages/Singularity.M4 due to --force
   == Singularity definition file created at /lustre/workspace/home/siddis14/ebimages/Singularity.M4
   == WARNING: overwriting existing container image at /lustre/workspace/home/siddis14/ebimages/M4.simg due to --force
   == Running 'sudo singularity build  /lustre/workspace/home/siddis14/ebimages/M4.simg /lustre/workspace/home/siddis14/ebimages/Singularity.M4', you may need to enter your 'sudo' password...
   == (streaming) output for command 'sudo singularity build  /lustre/workspace/home/siddis14/ebimages/M4.simg /lustre/workspace/home/siddis14/ebimages/Singularity.M4':
   [sudo] password for siddis14:
   Using container recipe deffile: /lustre/workspace/home/siddis14/ebimages/Singularity.M4
   Sanitizing environment
   Adding base Singularity environment to container
   Progress |===================================| 100.0%

   ...

   Building Singularity image...
   Singularity container built: /lustre/workspace/home/siddis14/ebimages/M4.simg
   Cleaning up...
   == Singularity image created at /lustre/workspace/home/siddis14/ebimages/M4.simg
   == Temporary log file(s) /tmp/eb-MdArgJ/easybuild-QrrfMy.log* have been removed.
   == Temporary directory /tmp/eb-MdArgJ has been removed.

Building multiple easyconfigs in containers
--------------------------------------------

easybuild supports multiple easyconfigs with ``--container*`` option where easyconfigs are passed inside the recipe file for build. 

Here is an example of building ``M4-1.4.17.eb`` and ``git-lfs-1.1.1.eb`` in a singularity container

.. code::

   [siddis14@amrndhl1157 easybuild-framework]$ eb M4-1.4.17.eb git-lfs-1.1.1.eb -C --container-base shub:shahzebsiddiqui/eb-singularity:centos-7.3.1611 --container-build --container-image-name=M4_git-lsf --containerpath /lustre/workspace/home/siddis14/ebimages --experimental --force
   == temporary log file in case of crash /tmp/eb-4KB4He/easybuild-DU4lNK.log
   == Singularity tool found at /usr/local/bin/singularity
   == Singularity version '2.4' is 2.4 or higher ... OK
   == Singularity definition file created at /lustre/workspace/home/siddis14/ebimages/Singularity.M4_git-lsf
   == Running 'sudo singularity build  /lustre/workspace/home/siddis14/ebimages/M4_git-lsf.simg /lustre/workspace/home/siddis14/ebimages/Singularity.M4_git-lsf', you may need to enter your 'sudo' password...
   == (streaming) output for command 'sudo singularity build  /lustre/workspace/home/siddis14/ebimages/M4_git-lsf.simg /lustre/workspace/home/siddis14/ebimages/Singularity.M4_git-lsf':
   Using container recipe deffile: /lustre/workspace/home/siddis14/ebimages/Singularity.M4_git-lsf
   Sanitizing environment
   Adding base Singularity environment to container
   Progress |===================================| 100.0%

   ...
   
   + su - easybuild
   == temporary log file in case of crash /scratch/tmp/eb-k7y90z/easybuild-0WGTeK.log
   == resolving dependencies ...
   == processing EasyBuild easyconfig /usr/easybuild/easyconfigs/m/M4/M4-1.4.17.eb
   == building and installing M4/1.4.17...
   == fetching files...
   == creating build dir, resetting environment...
   == unpacking...
   == patching...
   == preparing...
   == configuring...
   == building...
   == testing...
   == installing...
   == taking care of extensions...
   == postprocessing...
   == sanity checking...
   == cleaning up...
   == creating module...
   == permissions...
   == packaging...
   == COMPLETED: Installation ended successfully
   == Results of the build can be found in the log file(s) /app/software/M4/1.4.17/easybuild/easybuild-M4-1.4.17-20180419.192155.log
   == processing EasyBuild easyconfig /usr/easybuild/easyconfigs/g/git-lfs/git-lfs-1.1.1.eb
   == building and installing git-lfs/1.1.1...
   == fetching files...
   == creating build dir, resetting environment...
   == unpacking...
   == patching...
   == preparing...
   == configuring...
   == building...
   == testing...
   == installing...
   == taking care of extensions...
   == postprocessing...
   == sanity checking...
   == cleaning up...
   == creating module...
   == permissions...
   == packaging...
   == COMPLETED: Installation ended successfully
   == Results of the build can be found in the log file(s) /app/software/git-lfs/1.1.1/easybuild/easybuild-git-lfs-1.1.1-20180419.192157.log
   == Build succeeded for 2 out of 2
   == Temporary log file(s) /scratch/tmp/eb-k7y90z/easybuild-0WGTeK.log* have been removed.
   == Temporary directory /scratch/tmp/eb-k7y90z has been removed.
   + rm -rf '/scratch/tmp/*' /scratch/build /scratch/sources /scratch/ebfiles_repo

   ...
   
   Building Singularity image...
   Singularity container built: /lustre/workspace/home/siddis14/ebimages/M4_git-lsf.simg
   Cleaning up...
   == Singularity image created at /lustre/workspace/home/siddis14/ebimages/M4_git-lsf.simg
   == Temporary log file(s) /tmp/eb-4KB4He/easybuild-DU4lNK.log* have been removed.
   == Temporary directory /tmp/eb-4KB4He has been removed.
   [siddis14@amrndhl1157 easybuild-framework]$


If you go inside the container you will see both ``M4`` and ``git-lfs`` are installed inside the container

.. code::

   [siddis14@amrndhl1157 easybuild-framework]$ singularity shell -s /bin/bash /lustre/workspace/home/siddis14/ebimages/M4_git-lsf.simg
   Singularity: Invoking an interactive shell within container...

   Singularity> ml av

   ------------------------------------------------------------------------------------------------------------- /app/modules/all -------------------------------------------------------------------------------------------------------------
      M4/1.4.17 (L)    git-lfs/1.1.1 (L)

   -------------------------------------------------------------------------------------------------- /usr/share/lmod/lmod/modulefiles/Core ---------------------------------------------------------------------------------------------------
      lmod/6.5.1    settarg/6.5.1

     Where:
      L:  Module is loaded

   Use "module spider" to find all possible modules.
   Use "module keyword key1 key2 ..." to search for all possible modules matching any of the "keys".

Casecade builds for easybuild toolchain
----------------------------------------

Since easybuild invokes ``eb --robot`` in the recipe file, this can be problematic when building larger toolchains like ``GCCcore``, ``GCC``, ``gompi``, ``foss`` which will build the entire dependency list inside container that can increase container size and build time. To avoid this situation, try building the toolchains from bottom up and using them to bootstrap other toolchains.

Lets assume you are building ``GCCcore-5.4.0``, ``GCC-5.4.0-2.26``, ``gompi-2016.06`` and ``foss-2016.06``.

First build GCCcore-5.4.0

.. code::

        eb GCCcore-5.4.0.eb -C --container-base shub:shahzebsiddiqui/eb-singularity:centos-7.3.1611 --container-build --experimental

Once the image is built, assuming it is in default path do the following for GCC-5.4.0-2.26

.. code::

        eb GCC-5.4.0-2.26.eb -C --container-base localimage:$HOME/.local/easybuild/containers/GCCcore-5.4.0.simg --container-build --experimental

Afterwards build gompi-2016.06 using GCC-5.4.0-2.26 container image

.. code::

        eb gompi-2016.06.eb -C --container-base localimage:$HOME/.local/easybuild/containers/GCC-5.4.0-2.26.simg --container-build --experimental

Next build foss-2016.06 using gompi-2016.06 image

.. code::

        eb foss-2016.06.eb -C --container-base localimage:$HOME/.local/easybuild/containers/gompi-2016.06.simg --container-build --experimental





